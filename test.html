<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>DataTables + duckdb-wasm-kit demo</title>

  <!-- ❶  DataTables styling -->
  <link rel="stylesheet"
        href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">

  <style> body{font:16px/1.4 system-ui,sans-serif;margin:2rem} </style>
</head>
<body>
  <h2>ICE arrests (Parquet in S3, queried in-browser)</h2>
  <div id="root"></div>

  <!-- ❷  jQuery + DataTables in UMD builds (global) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

  <!-- ❸  All app logic lives in one ES-module block -->
  <script type="module">
    /* -- pull jQuery from the global that the <script> tags just created -- */
    const $ = window.jQuery;

    /* ---------- 3rd-party ESM imports ---------------------------------- */
    import React, {useEffect, useRef}  from "https://esm.sh/react@18";
    import {createRoot}                from "https://esm.sh/react-dom@18/client";
    import {
      useDuckDb, initializeDuckDb
    } from "https://esm.sh/duckdb-wasm-kit@0.1.39";

    /* warm-up the wasm bundle (optional) */
    initializeDuckDb({debug:false});

    /* ---------- helpers: translate DataTables JSON → SQL ---------------- */
    const esc = s => s.replace(/'/g, "''");

    function whereSQL(d){
      const parts=[];
      d.columns.forEach(col=>{
        if(col.search.value){
          parts.push(`${col.data} ILIKE '%${esc(col.search.value)}%'`);
        }
      });
      if(d.search.value){
        const term=esc(d.search.value);
        const ors=d.columns.filter(c=>c.searchable)
                            .map(c=>`${c.data} ILIKE '%${term}%'`);
        if(ors.length) parts.push('('+ors.join(' OR ')+')');
      }
      return parts.length ? 'WHERE '+parts.join(' AND ') : '';
    }

    function orderSQL(d){
      if(!d.order.length) return '';
      return 'ORDER BY ' +
        d.order.map(o=>{
          const col=d.columns[o.column];
          return `${col.data} ${o.dir.toUpperCase()}`;
        }).join(', ');
    }

    /* ---------- React component that owns the table -------------------- */
    function DuckTable(){
      const tblRef = useRef(null);
      const {db, loading, error} = useDuckDb();

      useEffect(()=>{
        if(loading || error || !db) return;

        (async ()=>{
          await db.execute("INSTALL httpfs; LOAD httpfs;");

          const parquetUrl =
            "https://deportationdata.s3.us-east-2.amazonaws.com/arrests.parquet";
          await db.execute(`
            CREATE OR REPLACE VIEW v AS
            SELECT * FROM read_parquet('${parquetUrl}')
          `);

          /* cached total row count */
          let totalRows;
          async function countAll(){
            if(totalRows===undefined){
              const [{cnt}] = await db.query("SELECT COUNT(*) AS cnt FROM v");
              totalRows = cnt;
            }
            return totalRows;
          }

          /* initialise DataTables */
          const dt = $(tblRef.current).DataTable({
            serverSide : true,
            processing : true,
            pageLength : 10,
            columns    : [
              {data:"case_id",    title:"Case ID"},
              {data:"gender",     title:"Gender"},
              {data:"country",    title:"Country"},
              {data:"birth_year", title:"Birth Year"}
            ],
            ajax : async (d, cb) => {
              const sql = `
                SELECT * FROM v
                ${whereSQL(d)}
                ${orderSQL(d)}
                LIMIT ${d.length} OFFSET ${d.start}
              `;
              const rows  = await db.query(sql);
              const total = await countAll();

              cb({
                draw            : d.draw,
                data            : rows,
                recordsTotal    : total,
                recordsFiltered : total      // quick; run COUNT(*) w/ WHERE for precision
              });
            }
          });

          /* clean up on unmount */
          return ()=>dt.destroy();
        })();

      },[db,loading,error]);

      /* render just an empty <table> element (no JSX) */
      return React.createElement(
        'table',
        {ref: tblRef, className: 'display', style:{width:'100%'}}
      );
    }

    /* ---------- mount the React app ----------------------------------- */
    createRoot(document.getElementById("root"))
      .render(React.createElement(DuckTable));

  </script>
</body>
</html>
