<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>DataTables + DuckDB-WASM (static, no React)</title>

<link rel="stylesheet"
      href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
<style>body{font:16px/1.4 system-ui,sans-serif;margin:2rem}</style>
</head>
<body>
<h2>ICE arrests (Parquet on S3, queried client-side)</h2>

<table id="arrests" class="display" style="width:100%"></table>

<!-- jQuery & DataTables (global UMD builds) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

<!-- Everything else lives here ----------------------------------------->
<script type="module">
/* 0 ─ helpers ───────────────────────────────────────────────────────── */
const $   = window.jQuery;
const esc = s => s.replace(/'/g,"''");

const whereSQL = d => {
  const parts = [];
  d.columns.forEach(c=>{
    if (c.search.value)
      parts.push(`${c.data} ILIKE '%${esc(c.search.value)}%'`);
  });
  if (d.search.value) {
    const term = esc(d.search.value);
    const ors  = d.columns.filter(c=>c.searchable)
                           .map(c=>`${c.data} ILIKE '%${term}%'`);
    if (ors.length) parts.push('('+ors.join(' OR ')+')');
  }
  return parts.length ? 'WHERE '+parts.join(' AND ') : '';
};

const orderSQL = d =>
  d.order.length
    ? 'ORDER BY ' + d.order.map(o=>{
        const col = d.columns[o.column];
        return `${col.data} ${o.dir.toUpperCase()}`;
      }).join(', ')
    : '';

/* 1 ─ DuckDB-WASM bootstrap (Blob wrapper avoids cross-origin Worker) ─ */
import * as duckdb from
  'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1/+esm';

const allBundles = duckdb.getJsDelivrBundles();               // object
const bundle     = await duckdb.selectBundle(Object.values(allBundles));

/* create a same-origin blob worker that just importScripts the real one */
const wrapperURL = URL.createObjectURL(new Blob(
  [`importScripts("${bundle.mainWorker}");`],
  {type: 'application/javascript'}
));

const worker = new Worker(wrapperURL);
const logger = new duckdb.ConsoleLogger('error');
const db     = new duckdb.AsyncDuckDB(logger, worker);
await db.instantiate(bundle);

await db.execute("INSTALL httpfs; LOAD httpfs;");             // enable HTTP Range

/* 2 ─ Point DuckDB at your Parquet (must allow CORS + Range) ─────────── */
const parquetUrl =
  "https://deportationdata.s3.us-east-2.amazonaws.com/arrests.parquet";
await db.execute(`
  CREATE OR REPLACE VIEW v AS
  SELECT * FROM read_parquet('${parquetUrl}')
`);

/* one-time total count (cached) */
let totalRows;
const countAll = async ()=>{
  if (totalRows === undefined) {
    const [{cnt}] = await db.query("SELECT COUNT(*) AS cnt FROM v");
    totalRows = cnt;
  }
  return totalRows;
};

/* 3 ─ DataTables in serverSide mode ──────────────────────────────────── */
$('#arrests').DataTable({
  serverSide : true,
  processing : true,
  pageLength : 10,

  columns : [
    {data:'case_id',    title:'Case ID'},
    {data:'gender',     title:'Gender'},
    {data:'country',    title:'Country'},
    {data:'birth_year', title:'Birth Year'}
  ],

  ajax : async (d, cb) => {
    const sql = `
      SELECT * FROM v
      ${whereSQL(d)}
      ${orderSQL(d)}
      LIMIT ${d.length} OFFSET ${d.start}
    `;
    const rows  = await db.query(sql);
    const total = await countAll();

    cb({
      draw            : d.draw,
      data            : rows,
      recordsTotal    : total,
      recordsFiltered : total      // quick; run COUNT(*) with WHERE for precision
    });
  }
});
</script>
</body>
</html>
