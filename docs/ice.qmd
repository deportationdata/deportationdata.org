---
title: "ICE: Immigration and Customs Enforcement"
---

```{r}
library(reactable)
library(tidyverse)

library(googlesheets4)
gs4_deauth()

# Define the URL of the Google Sheets document
url <- "https://docs.google.com/spreadsheets/d/1LD4WSEHNRwnTxIY6I9eau2VOqonOL0_MOhnIwknyzHQ/edit?gid=0#gid=0"
# Read the data from the Google Sheets document
tables <- read_sheet(url, sheet = "tables")
fields <- read_sheet(url, sheet = "fields_edited")
values <- read_sheet(url, sheet = "values", col_types = "c")
columns_recent <- read_sheet(url, sheet = "columns_recent")
missingness_df <- read_rds("../missingness_by_field.rds")
```

## Tables 

```{r}
# Give every <tr> a unique id
id_cell <- function(value) {
  htmltools::tags$span(id = paste0("row-", value), value)
}

reactable(
    tables |> 
       select(Name = `Descriptive name`, Description) |> arrange(Name),
    columns = list(
    Name = colDef(minWidth = 100, cell = id_cell),
    Description = colDef(minWidth = 200)), # set id anchor for linking
  pagination = FALSE,
  striped = TRUE,
  fullWidth = TRUE
)
```

## Fields (variables)

```{r}
#| column: page

check_def <- colDef(
  minWidth = 20,
  align = "center",
  html  = TRUE,     # allow htmltools tags
  filterable = FALSE,
  cell  = function(value) {
    if (identical(value, 1)) {
      htmltools::tags$div(
        style = "display: flex; justify-content: center; align-items: center;",
        htmltools::tags$i(
          class = "fas fa-check",
          style = "font-size: 1.2em; color: green;"
        )
      )
    } else {
      ""  # blank for 0, NA, or anything else
    }
  }
)

fields_tbl <- fields |> 
  mutate(
    name_merge = if_else(is.na(column_names), name_merge_recent, column_names) |>
      str_replace_all(" yes no", " (Yes/No)") |> 
      str_replace_all(" Yes No", " (Yes/no)")
  ) |> 
  select(Name = name_merge, Description = description, in_recent)

values_tbl <-
  values |> 
  distinct(Variable, Value, `Value label`) |> 
  unnest(Value) |> 
  filter(!is.na(Value)) 

reactable(
  fields_tbl |> select(-in_recent), 
  pagination = FALSE,
  striped    = TRUE,
  searchable = TRUE,
  filterable = TRUE,
  columns = list(
    Name = colDef(minWidth = 100),
    Description = colDef(minWidth = 200)
  ),
  details = function(index) {
  var_name <- fields_tbl$Name[index]

  val_tbl <- values_tbl |>
    filter(Variable == var_name) |>
    select(Value, `Value label`) |>
    arrange(Value)

  missgn_tbl <- missingness_df |>
    filter(column_names == var_name) |>
    select(-column_names)

  # collect the pieces we want to show
  pieces <- list()

  if (nrow(missgn_tbl) > 0) {
    pieces <- c(pieces,
      list(
        reactable(
          missgn_tbl,
          outlined = TRUE,
          compact  = TRUE          # optional: tighter rows
        )
      )
    )
  }

  # drop the Value-label column if itâ€™s all NA
  if (all(is.na(val_tbl$`Value label`))) {
    val_tbl$`Value label` <- NULL
  }

  if (nrow(val_tbl) > 0) {
    col_defs <- purrr::set_names(
      lapply(names(val_tbl), \(col)
        colDef(name = col, minWidth = 150)
      ),
      names(val_tbl)
    )

    pieces <- c(pieces,
      list(
        reactable(
          val_tbl,
          outlined = TRUE,
          compact  = TRUE,
          columns  = col_defs
        )
      )
    )
  }

  # nothing to show for this row
  if (length(pieces) == 0) return(NULL)

  htmltools::div(style = "padding: 1rem;", htmltools::tagList(pieces))
}

)
```