---
title: "ICE data codebook"
author:
  - name: Deportation Data Project
    url: "https://deportationdata.org"
  - name: "University of Washington Center for Human Rights"
    url: "https://jsis.washington.edu/humanrights"
---

```{r}
library(reactable)
library(tidyverse)
library(gt)

library(googlesheets4)
gs4_deauth()

# Define the URL of the Google Sheets document
url <- "https://docs.google.com/spreadsheets/d/1LD4WSEHNRwnTxIY6I9eau2VOqonOL0_MOhnIwknyzHQ/edit?gid=0#gid=0"
# Read the data from the Google Sheets document
tables <- read_sheet(url, sheet = "tables")
fields <- read_sheet(url, sheet = "fields_edited")
values <- read_sheet(url, sheet = "values", col_types = "c")
missingness_df <- read_rds("../../missingness_by_field.rds")
```

We provide a codebook for the main ICE data tables and fields. The codebook is a work in progress; there are many things we do not understand in the data, and some of our educated guesses here may be mistaken. We will continue to update the codebook as we learn more, and we welcome feedback and corrections.

## Data structure

In the arrests, detainers, encounters, and removals tables, each row represents a single enforcement action taken by ICE for a particular noncitizen. In many cases, noncitizens will appear more than once. Some are arrested more than once. Many are encountered more than once. A few are removed more than once, if they reenter the country.

The *detentions* table is more complex. Each row in the original ICE detentions data represents a single "*stint*" in detention at a particular detention center. Most noncitizens have only one stint per stay in detention, but some are transferred between detention centers during a single *stay*. 

To illustrate the data structure of the detentions table, we take two noncitizens as examples:
- Noncitizen A is detained from March 19 to March 21. They have a single stint in Otero County Processing Center. They have one *stay* and one *stint* within the stay.
- Noncitizen B is detained once, from June 6 to July 9, but during their stay in detention they are transferred between three facilities. They have a first stint at the Los Angeles hold room ("LOS CUST CASE") from June 6 to June 7, then they are transferred to Adelanto ICE Processing Center and held there from June 7 to July 25, and finally they are transferred to Desert View Annex and held there from July 25 to July 9. Noncitizen B has one stay with three stints.

These two citizens' stays in ICE detention would be represented in the *stint* level dataset like this:

```{r}
structure(
  list(
    unique_identifier = c(
      "00012713401ba69d788557ca1f630049da369b95",
      "007f7905068346a5f130769553963ce3ec1b02dc",
      "007f7905068346a5f130769553963ce3ec1b02dc",
      "007f7905068346a5f130769553963ce3ec1b02dc"
    ),
    stay_book_in_date_time = structure(
      c(1710846780, 1749214800, 1749214800, 1749214800),
      tzone = "UTC",
      class = c("POSIXct", "POSIXt")
    ),
    stay_book_out_date_time = structure(
      c(1710997740, 1752085560, 1752085560, 1752085560),
      tzone = "UTC",
      class = c("POSIXct", "POSIXt")
    ),
    book_in_date_time = structure(
      c(1710846780, 1749214800, 1749339000, 1750876560),
      tzone = "UTC",
      class = c("POSIXct", "POSIXt")
    ),
    detention_book_out_date_time = structure(
      c(1710997740, 1749288600, 1750876500, 1752085560),
      tzone = "UTC",
      class = c("POSIXct", "POSIXt")
    ),
    detention_facility = c(
      "OTERO CO PROCESSING CENTER",
      "LOS CUST CASE",
      "ADELANTO ICE PROCESSING CENTER",
      "DESERT VIEW ANNEX"
    )
  ),
  row.names = c(NA, -4L),
  class = c("tbl_df", "tbl", "data.frame")
) |>
  mutate(
    stay_ID = factor(unique_identifier, labels = c("Stay 1", "Stay 2")),
    unique_identifier = factor(unique_identifier, labels = c("A", "B")),
    across(where(is.POSIXct), ~ format(as.Date(.), "%b. %-d"))
  ) |>
  mutate(Stint = row_number(), .by = stay_ID, .after = unique_identifier) |>
  gt(groupname_col = "stay_ID") |>
  # group stay_book in/out into a group of columns
  tab_spanner(
    label = "Stay dates",
    columns = c(stay_book_in_date_time, stay_book_out_date_time)
  ) |>
  tab_spanner(
    label = "Stint dates",
    columns = c(book_in_date_time, detention_book_out_date_time)
  ) |>
  cols_label(
    unique_identifier = "Noncitizen ID",
    stay_book_in_date_time = "Book-in",
    stay_book_out_date_time = "Book-out",
    book_in_date_time = "Book-in",
    detention_book_out_date_time = "Book-out",
    detention_facility = "Detention facility",
    Stint = "Stint ID"
  ) |> 
  tab_options(row_group.as_column = TRUE) |> 
  tab_style(
    style = "vertical-align:top",
    locations = cells_body()
  ) 
```

These two citizens' stays in ICE detention would be represented in the *stay* level dataset like this, as two rows:

```{r}
structure(
  list(
    unique_identifier = c(
      "00012713401ba69d788557ca1f630049da369b95",
      "007f7905068346a5f130769553963ce3ec1b02dc",
      "007f7905068346a5f130769553963ce3ec1b02dc",
      "007f7905068346a5f130769553963ce3ec1b02dc"
    ),
    stay_book_in_date_time = structure(
      c(1710846780, 1749214800, 1749214800, 1749214800),
      tzone = "UTC",
      class = c("POSIXct", "POSIXt")
    ),
    stay_book_out_date_time = structure(
      c(1710997740, 1752085560, 1752085560, 1752085560),
      tzone = "UTC",
      class = c("POSIXct", "POSIXt")
    ),
    book_in_date_time = structure(
      c(1710846780, 1749214800, 1749339000, 1750876560),
      tzone = "UTC",
      class = c("POSIXct", "POSIXt")
    ),
    detention_book_out_date_time = structure(
      c(1710997740, 1749288600, 1750876500, 1752085560),
      tzone = "UTC",
      class = c("POSIXct", "POSIXt")
    ),
    detention_facility = c(
      "OTERO CO PROCESSING CENTER",
      "LOS CUST CASE",
      "ADELANTO ICE PROCESSING CENTER",
      "DESERT VIEW ANNEX"
    )
  ),
  row.names = c(NA, -4L),
  class = c("tbl_df", "tbl", "data.frame")
) |>
  mutate(
    stay_ID = factor(unique_identifier, labels = c("Stay 1", "Stay 2")),
    unique_identifier = factor(unique_identifier, labels = c("A", "B")),
    across(where(is.POSIXct), ~ format(as.Date(.), "%b. %-d"))
  ) |>
  group_by(
    stay_ID,
    unique_identifier,
    stay_book_in_date_time,
    stay_book_out_date_time
  ) |>
  summarize(n_stints = n()) |> 
  gt(groupname_col = "stay_ID") |>
  # group stay_book in/out into a group of columns
  tab_spanner(
    label = "Stay dates",
    columns = c(stay_book_in_date_time, stay_book_out_date_time)
  ) |>
  cols_label(
    unique_identifier = "Noncitizen ID",
    stay_book_in_date_time = "Book-in",
    stay_book_out_date_time = "Book-out",
    n_stints = "# of Stints"
  ) |> 
  tab_options(row_group.as_column = TRUE) |> 
  tab_style(
    style = "vertical-align:top",
    locations = cells_body()
  ) 
```
  
## Tables 
  
We describe the main ICE data tables below.
  
```{r}
# Give every <tr> a unique id
id_cell <- function(value) {
  htmltools::tags$span(id = paste0("row-", value), value)
}

reactable(
  tables |> select(Name = `Descriptive name`, Description) |> arrange(Name),
  columns = list(
    Name = colDef(minWidth = 100, cell = id_cell),
    Description = colDef(minWidth = 200, sortable = FALSE)
  ), # set id anchor for linking
  pagination = FALSE,
  striped = TRUE,
  fullWidth = TRUE,
  theme = reactableTheme(
    # clear the table itself
    tableStyle = list(backgroundColor = "transparent"),
    # keep the cells transparent too
    headerStyle = list(backgroundColor = "transparent")
  )
)
```

## Fields (variables) in latest data release

We describe the fields (a.k.a. variables or columns) in the latest ICE data release below. The table includes the name of each field, a description, and the type of data in the field (e.g., string, numeric, date). Expanding a row will show an indicator for whether the field is available in each table and the proportion missing. 

```{r}
check_def <- colDef(
  width = 130,
  align = "center",
  style = list(whiteSpace = "nowrap"),
  html = TRUE, # allow htmltools tags
  cell = function(value) {
    if (identical(value, "Y")) {
      htmltools::tags$div(
        style = "display: flex; justify-content: center; align-items: center;",
        htmltools::tags$i(
          class = "fas fa-check",
          style = "font-size: 1.2em; color: green;"
        )
      )
    } else if (identical(value, "R")) {
      htmltools::tags$div(
        style = "display: flex; justify-content: center; align-items: center;",
        htmltools::tags$i(
          class = "fas fa-exclamation-triangle",
          style = "font-size: 1.2em; color: orange;"
        )
      )
    } else if (identical(value, "N")) {
      ""
    } else if (!is.na(value)) {
      value
    } else if (is.na(value)) {
      "—"
    }
  }
)

fields_tbl <-
  fields |>
  filter(!name_in_foia_request %in% c("felon", "msc_conviction_date")) |>
  select(-`Admin Arrests`, -Detainers, -Encounters, -Detentions, -Removals) |>
  select(-in_recent) |>
  mutate(
    name_merge = if_else(is.na(column_names), name_merge_recent, column_names)
  ) |>
  # recode from "Alien File Number" to "Anonymized Identifier"; "Case ID" to "EID Case ID"; "Subject ID" to "EID Subject ID"
  mutate(
    name_merge = str_replace_all(
      name_merge,
      "Alien File Number",
      "Anonymized Identifier"
    ),
    name_merge = str_replace_all(name_merge, "Case ID", "EID Case ID"),
    name_merge = str_replace_all(name_merge, "Subject ID", "EID Subject ID")
  ) |>
  filter(!is.na(name_merge)) |>
  left_join(
    missingness_df |> mutate(in_recent = 1),
    by = c("name_merge" = "field")
  ) |>
  mutate(
    in_recent = if_else(is.na(in_recent), 0, in_recent)
  ) |>
  rename(Name = name_merge, Description = description, Type = type)

fields_tbl_redacted <-
  fields_tbl |>
  select(Name, contains("redacted") | contains("missing")) |>
  pivot_longer(
    cols = c(everything(), -Name),
    names_to = c("type", ".value"),
    names_sep = "_",
    values_drop_na = FALSE
  ) |>
  filter(type == "redacted") |>
  select(-type) |>
  # pivot longer but keep Name
  pivot_longer(
    cols = c(everything(), -Name),
    names_to = "Table",
    values_to = "redaction_value"
  ) |>
  group_by(Name) |>
  summarise(
    all_redacted = !all(is.na(redaction_value)) &&
      all(redaction_value[!is.na(redaction_value)] == 1),
    any_redacted = any(redaction_value == 1, na.rm = TRUE),
    .groups = "drop"
  )

fields_tbl <-
  fields_tbl |>
  left_join(fields_tbl_redacted, by = "Name") |>
  filter(all_redacted == FALSE) |>
  select(-all_redacted, -any_redacted)

values_tbl <-
  values |>
  distinct(Variable, Value, `Value label`) |>
  unnest(Value) |>
  filter(!is.na(Value))

reactable(
  fields_tbl |>
    filter(in_recent == 1) |>
    select(Name, Description, Type) |>
    mutate(
      Name = Name |>
        str_replace_all(" yes no", " (Yes/No)") |>
        str_replace_all(" Yes No", " (Yes/no)")
    ) |>
    arrange(Name),
  pagination = FALSE,
  striped = TRUE,
  searchable = TRUE,
  filterable = FALSE,
  theme = reactableTheme(
    # clear the table itself
    tableStyle = list(backgroundColor = "transparent"),
    # keep the cells transparent too
    headerStyle = list(backgroundColor = "transparent")
  ),
  columns = list(
    Name = colDef(minWidth = 100),
    Description = colDef(minWidth = 200, sortable = FALSE),
    Type = colDef(minWidth = 65)
  ),
  details = function(index) {
    var_name <- fields_tbl |>
      filter(in_recent == 1) |>
      arrange(Name) |>
      slice(index) |>
      pull(Name)

    val_tbl <- values_tbl |>
      filter(Variable == var_name) |>
      select(Value, `Value label`) |>
      arrange(Value)

    missgn_tbl <-
      fields_tbl |>
      filter(Name == var_name) |>
      select(contains("redacted") | contains("missing")) |>
      pivot_longer(
        cols = everything(),
        names_to = c("type", ".value"),
        names_sep = "_",
        values_drop_na = FALSE
      ) |>
      select(-type) |>
      # set row names to be c("In latest data", "% missing in latest")
      mutate(
        rownames = if_else(row_number() == 1, "In latest data?", "% missing"),
        across(where(is.numeric), ~ as.character(round(. * 100))),
        across(
          c(everything(), -rownames),
          ~ case_when(
            row_number() == 1 & is.na(.) ~ "N",
            row_number() == 1 & !is.na(.) & . == 0 ~ "Y",
            row_number() == 1 & !is.na(.) & . == 1 ~ "R",
            row_number() == 2 & is.na(.) ~ NA_character_,
            TRUE ~ .
          )
        )
      ) |>
      relocate(rownames)

    # collect the pieces we want to show
    pieces <- list()

    # Determine if this is an odd or even row (1-indexed)
    row_color <- if (index %% 2 == 0) "white" else "#F7F7F7"

    if (nrow(missgn_tbl) > 0) {
      pieces <- c(
        pieces,
        list(
          htmltools::tags$h4(
            style = "margin-top: 0rem; margin-bottom: 0.5rem;",
            "Data availability and missingness"
          ),
          reactable(
            missgn_tbl,
            # outlined = TRUE,
            sortable = FALSE,
            # striped = TRUE,
            fullWidth = FALSE,
            # make the table transparent
            theme = reactableTheme(
              backgroundColor = row_color,
              borderColor = "#ddd",
              headerStyle = list(backgroundColor = row_color),
              # add horizontal lines only in between rows
              rowStyle = list(
                borderBottom = "1px solid #ddd",
                backgroundColor = row_color
              ),
              # add vertical spacing at bottom
              footerStyle = list(paddingBottom = "2rem")
            ),
            columns = list(
              # set columns to be check if "Y"
              rownames = colDef(
                name = "",
                style = list(whiteSpace = "nowrap"),
                width = 125,
                align = "left"
              ),
              `Admin Arrests` = check_def,
              Detainers = check_def,
              Encounters = check_def,
              Detentions = check_def,
              Removals = check_def
            )
          )
        )
      )
    }

    # drop the Value-label column if it’s all NA
    if (all(is.na(val_tbl$`Value label`))) {
      val_tbl$`Value label` <- NULL
    }

    if (nrow(val_tbl) > 0) {
      col_defs <- purrr::set_names(
        lapply(names(val_tbl), \(col) {
          colDef(name = col, minWidth = 150)
        }),
        names(val_tbl)
      )

      # pieces <- c(pieces,
      #   list(
      #     htmltools::tags$h4(
      #       style = glue::glue("margin-bottom: 1rem;"),
      #       "Values and value labels"
      #     ),
      #     reactable(
      #       val_tbl,
      #       # outlined = TRUE,
      #       compact  = TRUE,
      #       # striped = TRUE,
      #       theme = reactableTheme(
      #         backgroundColor = row_color,
      #         borderColor = "#ddd",
      #         headerStyle = list(backgroundColor = row_color),
      #         # add horizontal lines only in between rows
      #         rowStyle = list(
      #           borderBottom = "1px solid #ddd",
      #           backgroundColor = row_color
      #         )
      #       ),
      #       defaultPageSize = 25,
      #       columns  = col_defs
      #     )
      #   )
      # )
    }

    # nothing to show for this row
    if (length(pieces) == 0) {
      return(NULL)
    }

    htmltools::div(
      style = paste0(
        "padding: 1rem; margin-bottom: 1.5rem; background-color: ",
        row_color,
        ";"
      ),
      htmltools::tagList(pieces)
    )
  }
)
```

### Fields (variables) in previous data releases

We also provide a table of fields (a.k.a. variables or columns) that were available in previous ICE data releases but are not included in the most recent data. This table includes the name of each field, a description, and the type of data in the field (e.g., string, numeric, date). 

```{r}
reactable(
  fields_tbl |>
    filter(in_recent == 0) |>
    select(Name, Description, Type) |>
    mutate(
      Name = Name |>
        str_replace_all(" yes no", " (Yes/No)") |>
        str_replace_all(" Yes No", " (Yes/no)")
    ) |>
    arrange(Name),
  pagination = FALSE,
  striped = TRUE,
  searchable = TRUE,
  filterable = FALSE,
  theme = reactableTheme(
    # clear the table itself
    tableStyle = list(backgroundColor = "transparent"),
    # keep the cells transparent too
    headerStyle = list(backgroundColor = "transparent")
  ),
  columns = list(
    Name = colDef(minWidth = 100),
    Description = colDef(minWidth = 200, sortable = FALSE),
    Type = colDef(minWidth = 65)
  )
)
```
