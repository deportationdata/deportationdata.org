---
title: "ICE Offices and Areas of Responsibility"
format: html
toc: false
---

We provide tabular and spatial data on ICE field offices and their areas of responsibility (AOR) for use in conjunction with our [ICE data](/data/ice.html). 

```{r}
#| echo: false
#| message: false
#| warning: false

library(tidyverse)
library(sf)
library(sfarrow)
library(leaflet.extras2)

field_offices_sf <- sfarrow::st_read_feather(
  "https://github.com/deportationdata/ice/raw/refs/heads/ice-offices/data/ice-offices-shp.feather"
)

aor_sf <- sfarrow::st_read_feather(
  "https://github.com/deportationdata/ice/raw/refs/heads/ice-offices/data/ice-aor-df.feather"
) |>
  rename(`Area of Responsibility` = `Area.of.Responsibility`)

aor_centroid_coords <-
  aor_sf |>
  st_transform(4326) |>
  st_point_on_surface() |>
  mutate(
    lng = st_coordinates(geometry)[, 1],
    lat = st_coordinates(geometry)[, 2]
  ) |>
  st_drop_geometry()

icons_lst <- awesomeIconList(
  "Field office" = makeAwesomeIcon(
    icon = 'office',
    markerColor = 'blue',
    iconColor = 'black',
    library = "glyphicon"
  )
)

leaflet() |>
  addProviderTiles(providers$CartoDB.PositronNoLabels) |>
  addPolygons(
    data = aor_sf |> st_transform(4326),
    weight = 1,
    opacity = 1,
    color = gray(0.45),
    fill = NA,
    group = "ICE areas of responsibility"
  ) |>
  addMarkers(
    data = field_offices_sf |> filter(sub_office == FALSE, agency == "ERO"),
    group = "ICE ERO field offices",
    # make markers half size
    icon = makeIcon(
      iconUrl = "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
      shadowUrl = "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
      iconWidth = 15, # Half the default size (25)
      iconHeight = 25, # Half the default size (41)
      iconAnchorX = 7, # Half of iconWidth
      iconAnchorY = 25, # Bottom of icon
      shadowWidth = 20, # Proportionally smaller shadow
      shadowHeight = 20,
      shadowAnchorX = 5,
      shadowAnchorY = 20
    ),
  ) |>
  addLabelOnlyMarkers(
    data = aor_centroid_coords,
    lng = ~lng,
    lat = ~lat,
    label = ~`Area of Responsibility`,
    labelOptions = labelOptions(
      noHide = TRUE,
      textOnly = TRUE,
      direction = "center",
      style = list(
        "color" = gray(0.35),
        "font-size" = "12px",
        # "font-weight" = "bold",
        "text-shadow" = "-1px -1px 0 #ffffff, 1px -1px 0 #ffffff, -1px 1px 0 #ffffff, 1px 1px 0 #ffffff"
      )
    ),
    group = "ICE areas of Responsibility"
  ) |>
  addLayersControl(
    overlayGroups = c(
      "ICE ERO areas of responsibility",
      "ICE ERO field offices"
    ),
    position = "bottomleft",
    options = layersControlOptions(
      collapsed = FALSE
    )
  ) |>
  # hideGroup("ICE ERO field offices") |>
  setView(lng = -96.5795, lat = 37.8283, zoom = 4)
```

<p></p>

Map includes two layers:

- **ICE Enforcement and Removal Operations (ERO) field offices**: Locations of ICE ERO field offices (not including sub-offices).
- **ICE areas of responsibility**: Geographic region managed by each ICE field office. 

<span style="display:block; height:10px;"></span>

## ICE Enforcement and Removal Operations field offices

We provide a table of ICE ERO field offices, their addresses, and their areas of responsibility. Some ICE ERO field offices have sub-offices (check-in locations) that serve specific areas within the main office's area of responsibility. <i class="bi bi-caret-right-fill"></i> expands the field office row to show its sub-offices and their coverage areas.

```{r}
library(reactable)

sub_offices_sf <-
  field_offices_sf |>
  filter(sub_office == TRUE)

field_offices_sf <-
  # merge in sub-office df as a list column by main_office
  field_offices_sf |>
  filter(sub_office == FALSE, agency == "ERO") |>
  left_join(
    sub_offices_sf |>
      st_drop_geometry() |>
      transmute(
        field_office_name,
        sub_office_name = office_name,
        sub_office_area = area
      ),
    by = c("office_name" = "field_office_name")
  ) |>
  group_by(office_name) |>
  # I want to collapse into one row per office name and have all the sub-office details in a list column
  summarise(
    address = first(address),
    city = first(city),
    state = first(state),
    zip = first(zip),
    area = first(area),
    sub_offices = list(tibble(sub_office_name, sub_office_area)),
    .groups = "drop"
  )

field_offices_sf |>
  mutate(
    Address = glue::glue("{address}, {city}, {state} {zip}")
  ) |>
  st_drop_geometry() |>
  select(Office = office_name, `Coverage area` = area, Address, sub_offices) |>
  reactable(
    pagination = TRUE,
    striped = TRUE,
    defaultPageSize = 5,
    theme = reactableTheme(
      tableStyle = list(backgroundColor = "transparent"),
      headerStyle = list(backgroundColor = "transparent")
    ),
    details = function(index) {
      # Get the sub_offices data for this row
      sub_office_data <- field_offices_sf$sub_offices[[index]]

      # Filter out NA values
      sub_office_data <- sub_office_data |>
        filter(!is.na(sub_office_name))

      # If no sub-offices, return NULL (no details row)
      if (nrow(sub_office_data) == 0) {
        return(NULL)
      }

      # Create a reactable for the sub-offices
      sub_office_data |>
        select(
          `Sub-office` = sub_office_name,
          `Coverage area` = sub_office_area
        ) |>
        reactable(
          outlined = TRUE,
          highlight = TRUE,
          borderless = TRUE,
          striped = FALSE,
          columns = list(
            `Sub-office` = colDef(minWidth = 120),
            `Coverage area` = colDef(minWidth = 200)
          ),
          theme = reactableTheme(
            tableStyle = list(fontSize = "14px"),
            headerStyle = list(backgroundColor = "#f8f9fa")
          )
        )
    },
    columns = list(
      sub_offices = colDef(show = FALSE) # Hide the sub_offices column
    )
  )
```

## Data downloads

Download the data used to create the map and table above in multiple formats, including tabular data and spatial data that represents the location of each office or area. 

```{r}
library(reactable)
download_df <-
  tribble(
    ~name,
    ~description,
    ~last_updated,
    ~download,
    "ICE office location dataset",
    "Field offices for each ICE agency (ERO, HSI, JIATF, LESC, OPE, OPLA, and OPR) and ERO check-in offices (sub-offices)",
    as.Date("2025-09-30"),
    list(
      list(
        "https://github.com/deportationdata/ice/raw/refs/heads/main/data/ice-offices.xlsx",
        "",
        "xlsx"
      ),
      list(
        "https://github.com/deportationdata/ice/raw/refs/heads/main/data/ice-offices.feather",
        "",
        "feather"
      ),
      list(
        "https://github.com/deportationdata/ice/raw/refs/heads/main/data/ice-offices.dta",
        "",
        "dta"
      ),
      list(
        "https://github.com/deportationdata/ice/raw/refs/heads/main/data/ice-offices.sav",
        "",
        "sav"
      )
    ),
    "ICE office location shapefile",
    "Field offices for each ICE agency (ERO, HSI, JIATF, LESC, OPE, OPLA, and OPR) and ERO check-in offices (sub-offices). Provided as a shapefile with point geometries, in both a ZIP file with the .shp and associated files, and as a Feather file with simple feature geometries.",
    as.Date("2025-09-30"),
    list(
      list(
        "https://github.com/deportationdata/ice/raw/refs/heads/main/data/ice-offices.zip",
        "",
        "shp"
      ),
      list(
        "https://github.com/deportationdata/ice/raw/refs/heads/main/data/ice-offices.feather",
        "",
        "feather"
      )
    ),
    "ICE ERO areas of responsibility shapefile",
    "Geographic areas of responsibility for each ICE ERO field office. Provided as a shapefile with polygon geometries, in both a ZIP file with the .shp and associated files, and as a Feather file with simple feature geometries.",
    as.Date("2025-09-30"),
    list(
      list(
        "https://github.com/deportationdata/ice/raw/refs/heads/main/data/ice-aor-shp.zip",
        "",
        "shp"
      ),
      list(
        "https://github.com/deportationdata/ice/raw/refs/heads/main/data/ice-aor-shp.feather",
        "",
        "feather"
      )
    )
  )

reactable(
  download_df,
  pagination = FALSE,
  striped = TRUE,
  theme = reactableTheme(
    tableStyle = list(backgroundColor = "transparent"),
    headerStyle = list(backgroundColor = "transparent")
  ),
  details = function(index) {
    # Get the description for this row
    description_text <- download_df[index, ]$description

    # Return HTML with the description
    htmltools::div(
      style = "padding: 16px; background-color: #f8f9fa; border-left: 3px solid #007bff;",
      htmltools::strong("Description: "),
      description_text
    )
  },
  columns = list(
    name = colDef(
      name = "Dataset",
      minWidth = 200
    ),
    description = colDef(show = FALSE), # Hide the description column
    last_updated = colDef(
      name = "Last updated",
      format = colFormat(date = TRUE)
    ),
    download = colDef(
      name = "Download",
      minWidth = 85,
      html = TRUE,
      header = function(value) {
        htmltools::tags$span(
          `data-bs-toggle` = "tooltip",
          `data-bs-placement` = "top",
          title = "Download data cleaned and processed by the Deportation Data Project",
          "Download"
        )
      },
      cell = function(value) {
        if (is.null(value) || length(value) == 0 || is.na(value[[1]][[1]])) {
          return("&ndash;") # en dash
        }

        links <- map(
          value,
          ~ {
            paste0(
              "<a href='",
              .x[[1]],
              "'>",
              "<img src='/img/",
              .x[[3]],
              ".svg' width=25 height=25 alt='",
              .x[[3]],
              "'>",
              "</a>"
            )
          }
        )

        paste(links, collapse = " ")
      }
    )
  )
)
```