---
title: "Data download tool"
page-layout: full
format:
  html:
    code-tools: false 
    css: https://cdn.datatables.net/2.3.2/css/dataTables.bootstrap5.css
---

```{r}
library(DT)

htmltools::tags$style(htmltools::HTML("
  thead input { display: none; }     /* Hide text inputs */
  thead select { display: block; }   /* Show selects if present */
"))

server_url <- "https://ddp-api-4bcgl.ondigitalocean.app"

df <- arrow::read_feather("https://github.com/deportationdata/ice/releases/latest/download/arrests-latest.feather")
df <- df[0, ]

DT::datatable(
  df,
  rownames = FALSE,
  extensions = "Buttons",
  class = 'table table-striped nowrap',
  filter = "top",  # use select dropdown filters at the top of each column
  options = list(
    dom = "Bt",  # no 'f' â†’ hides the global search box
    serverSide = TRUE,
    processing = TRUE,
    ajax = list(
      url = glue::glue("{server_url}/data"),
      type = "GET"
    ),
    columns = lapply(names(df), function(col) list(data = col)),
    buttons = list(
      list(
        extend = "collection",
        text   = "Download filtered data",
        className = "btn btn-outline-primary btn-sm",  # <- use your site style
        buttons = list(
          list(
            extend = "csv",
            text   = "CSV",
            className = "btn btn-outline-primary btn-sm",
            action = DT::JS(glue::glue("
              function (e, dt, node) {{
                var params = dt.ajax.params();
                params.start = 0;
                params.length = -1;
                var query = $.param(params) + '&format=csv';
                var url   = '{server_url}/download?' + query;
                window.open(url, '_blank');
              }}
            "))
          ),
          list(
            extend = "csv",
            text   = "Excel (.xlsx)",
            className = "btn btn-outline-primary btn-sm",
            action = DT::JS(glue::glue("
              function (e, dt, node) {{
                var params = dt.ajax.params();
                params.start = 0;
                params.length = -1;
                var query = $.param(params) + '&format=xlsx';
                var url   = '{server_url}/download?' + query;
                window.open(url, '_blank');
              }}
            "))
          ),
          list(
            extend = "csv",
            text   = "Stata (.dta)",
            className = "btn btn-outline-primary btn-sm",
            action = DT::JS(glue::glue("
              function (e, dt, node) {{
                var params = dt.ajax.params();
                params.start = 0;
                params.length = -1;
                var query = $.param(params) + '&format=dta';
                var url   = '{server_url}/download?' + query;
                window.open(url, '_blank');
              }}
            "))
          )
        )
      )
    ),
    columnDefs = list(
      list(
        targets = 1:(ncol(df) - 1),
        searchable = FALSE  # only first column is searchable/filterable
      )
    )
  )
)
```